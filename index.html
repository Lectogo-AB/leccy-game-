
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>R칛ven hoppar!</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="introPopup">
    <h2>Hj칛lp Leccy!</h2>
    <p>Samla po칛ng genom att hoppa mellan plattformar.</p>
    <p>Du har tre liv = 仇벒잺仇벒잺仇벒잺</p>
    <p>Varje g친ng du faller eller nuddar ett l친gt batteri f칬rlorar du ett liv och b칬rjar om fr친n b칬rjan.</p>
    <div style="margin: 16px 0; background: #f8f8f8; padding: 12px; border-radius: 8px;">
      <strong>游꾸 Vinsttabell:</strong><br>
      25 po칛ng = 30 kr att ladda f칬r<br>
      50 po칛ng = 100 kr att ladda f칬r
    </div>
    <button id="startBtn">Starta spelet</button>
  </div>

  <div id="gameOverPopup" style="display:none;">
    <h3 id="gameOverTitle">Game Over!</h3>
    <p>Po칛ng: <span id="finalScore">0</span></p>
    <div id="rewardSection" style="display:none;">
      <p>游꿀 Du vann laddkrediter!<br>
      Din kod 칛r:<br><strong id="rewardCode">XXXXX</strong></p>
    </div>
    <div id="noRewardSection" style="display:none;">
      <p>F칬rs칬k igen n칛sta vecka!<br>
      Snurra lyckohjulet varje dag f칬r en ny chans.</p>
    </div>
    <button onclick="goBack()">Tillbaka till appen</button>
  </div>

  <canvas id="gameCanvas" width="375" height="667"></canvas>

  <script>
    const sheetUrl = "https://script.google.com/macros/s/AKfycbwMo8LRdofYLb9ne7OpJbHLJjM6GT-csazPhyoYnBs833cHtJQPHPFrXZTN4Epi-KTV/exec";
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const foxImg = new Image();
    foxImg.src = "https://i.ibb.co/ZpTgFfVf/Adorable-Chibi-Fox-Illustration.png";

    let fox = { x: 150, y: 600, width: 40, height: 40, vy: 0, gravity: 0.12, jumpStrength: -5.4 };
    let platforms = [], hazards = [], bonuses = [];
    const platformHeight = 10, hazardSize = 20, bonusSize = 20, platformCount = 100, maxScore = 100;
    let verticalSpacing = 100, scrollOffset = 0, score = 0, lives = 3, bonusGiven = false, visitedPlatforms = new Set();
    let keys = {}, tilt = 0;

    if (window.DeviceOrientationEvent) {
      window.addEventListener("deviceorientation", e => tilt = e.gamma, true);
    }

    function createPlatforms() {
      platforms = []; hazards = []; bonuses = []; visitedPlatforms.clear(); scrollOffset = 0; bonusGiven = false;
      let lastX = 150, lastY = 650, lastSide = 'right';
      for (let i = 0; i < platformCount; i++) {
        verticalSpacing = i < 15 ? 100 : i < 30 ? 110 : 130;
        if (i > 30 && i % 5 === 0) continue;
        let y = lastY - verticalSpacing + Math.random() * 10 - 5;
        let shift = Math.random() * 70 + 130;
        let x = lastSide === 'right' ? Math.max(0, lastX - shift) : Math.min(canvas.width - 60, lastX + shift);
        lastSide = lastSide === 'right' ? 'left' : 'right';
        x = Math.min(canvas.width - 60, Math.max(0, x + (Math.random() < 0.3 ? Math.random() * 60 - 30 : 0)));
        let width = i >= 30 ? Math.floor(Math.random() * 20) + 40 : 60;
        platforms.push({ x, y, width });
        if (i > 20 && Math.random() < 0.4) {
          let hX = x + 10 + Math.random() * (width - hazardSize - 20);
          hazards.push({ x: hX, y: y - hazardSize });
        }
        if (!bonusGiven && i >= 50) {
          bonuses.push({ x: x + width / 2 - bonusSize / 2, y: y - bonusSize });
          bonusGiven = true;
        }
        lastX = x; lastY = y;
      }
      fox.x = platforms[0].x + platforms[0].width / 2 - fox.width / 2;
      fox.y = platforms[0].y - fox.height; fox.vy = 0;
    }

    function drawFox() { ctx.drawImage(foxImg, fox.x, fox.y, fox.width, fox.height); }
    function drawPlatforms() {
      ctx.fillStyle = "#0077FF";
      platforms.forEach(p => ctx.fillRect(p.x, p.y + scrollOffset, p.width, platformHeight));
    }
    function drawHazards() {
      ctx.font = "20px sans-serif";
      hazards.forEach(h => ctx.fillText("驕멆잺", h.x, h.y + scrollOffset + 18));
    }
    function drawBonuses() {
      ctx.fillStyle = "gold";
      bonuses.forEach(b => ctx.fillRect(b.x, b.y + scrollOffset, bonusSize, bonusSize));
    }
    function drawUI() {
      ctx.font = "20px sans-serif";
      for (let i = 0; i < lives; i++) ctx.fillText("仇벒잺", 12 + i * 22, 26);
      ctx.fillStyle = "#ccc"; ctx.fillRect(10, 40, 100, 10);
      ctx.fillStyle = "#00c853"; ctx.fillRect(10, 40, Math.min(score / maxScore, 1) * 100, 10);
      ctx.fillStyle = "#000"; ctx.fillText("Po칛ng: " + score, 10, 70);
    }

    function update() {
      fox.vy += fox.gravity; fox.y += fox.vy;
      if (keys["ArrowLeft"]) fox.x -= 2;
      if (keys["ArrowRight"]) fox.x += 2;
      if (Math.abs(tilt) > 3) fox.x += tilt * 0.15;
      fox.x = Math.max(0, Math.min(canvas.width - fox.width, fox.x));

      platforms.forEach((p, i) => {
        let pY = p.y + scrollOffset;
        if (fox.vy > 0 && fox.x + fox.width > p.x && fox.x < p.x + p.width && fox.y + fox.height >= pY && fox.y + fox.height <= pY + platformHeight) {
          fox.vy = fox.jumpStrength;
          if (!visitedPlatforms.has(i)) score++, visitedPlatforms.add(i);
        }
      });

      hazards.forEach((h, i) => {
        let hY = h.y + scrollOffset;
        if (fox.x + fox.width > h.x + 4 && fox.x < h.x + hazardSize - 4 && fox.y + fox.height > hY + 4 && fox.y < hY + hazardSize - 4) {
          lives--; hazards.splice(i, 1);
          if (lives > 0) { createPlatforms(); score = 0; } else endGame();
        }
      });

      bonuses.forEach((b, i) => {
        let bY = b.y + scrollOffset;
        if (fox.x + fox.width > b.x && fox.x < b.x + bonusSize && fox.y + fox.height > bY && fox.y < bY + bonusSize) {
          if (lives < 3) lives++;
          bonuses.splice(i, 1);
        }
      });

      if (fox.y < canvas.height / 2) {
        let delta = canvas.height / 2 - fox.y;
        scrollOffset += delta; fox.y = canvas.height / 2;
        platforms.forEach(p => p.y += delta);
        hazards.forEach(h => h.y += delta);
        bonuses.forEach(b => b.y += delta);
      }

      if (fox.y > canvas.height) {
        lives--;
        if (lives > 0) { createPlatforms(); score = 0; } else endGame();
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawPlatforms(); drawHazards(); drawBonuses(); drawFox(); drawUI();
    }

    function gameLoop() {
      update(); draw(); requestAnimationFrame(gameLoop);
    }

    function endGame() {
      document.getElementById("finalScore").textContent = score;
      const popup = document.getElementById("gameOverPopup");
      const rewardSection = document.getElementById("rewardSection");
      const noRewardSection = document.getElementById("noRewardSection");

      if (score >= 25) {
        const category = score >= 50 ? 2 : 1;
        fetch(sheetUrl + "?category=" + category)
          .then(res => res.json())
          .then(data => {
            document.getElementById("rewardCode").textContent = data.code || "Inga koder kvar";
            rewardSection.style.display = "block";
            noRewardSection.style.display = "none";
            popup.style.display = "block";
          });
      } else {
        rewardSection.style.display = "none";
        noRewardSection.style.display = "block";
        popup.style.display = "block";
      }
    }

    function goBack() {
      window.location.href = "leccyapp://home";
    }

    const streak = 7;
    document.getElementById("startBtn").addEventListener("click", () => {
      document.getElementById("introPopup").style.display = "none";
      if (streak >= 7) {
        createPlatforms(); gameLoop();
      } else {
        alert("Du m친ste ha en streak p친 7 dagar p친 lyckohjulet f칬r att spela!");
      }
    });

    document.addEventListener("keydown", e => keys[e.key] = true);
    document.addEventListener("keyup", e => keys[e.key] = false);
  </script>
</body>
</html>
