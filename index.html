<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>R√§ven hoppar!</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="introPopup">
    <h2>Hj√§lp Leccy!</h2>
    <p>Samla po√§ng genom att hoppa mellan plattformar.</p>
    <p>Du har tre liv = ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</p>
    <p>Varje g√•ng du faller eller nuddar ett ‚ò†Ô∏è s√• f√∂rlorar du ett liv och b√∂rjar om fr√•n b√∂rjan.</p>
    <p><strong>Tips: luta mobilen f√∂r att styra r√§ven!</strong></p>
    <div style="margin: 16px 0; background: #f8f8f8; padding: 12px; border-radius: 8px;">
      <strong>üéÅ Vinsttabell:</strong><br>
      25 po√§ng = 30 kr att ladda f√∂r<br>
      50 po√§ng = 100 kr att ladda f√∂r
    </div>
    <button id="startBtn">Starta spelet</button>
  </div>

  <div id="gameOverPopup" style="display:none;">
    <h3 id="gameOverTitle">Game Over!</h3>
    <p>Po√§ng: <span id="finalScore">0</span></p>
    <div id="rewardSection" style="display:none;">
      <p>üéâ Du vann laddkrediter!<br>
      Din kod √§r:<br><strong id="rewardCode">XXXXX</strong></p>
    </div>
    <div id="noRewardSection" style="display:none;">
      <p>F√∂rs√∂k igen n√§sta vecka!<br>
      Snurra lyckohjulet varje dag f√∂r en ny chans.</p>
    </div>
    <button onclick="goBack()">Tillbaka till appen</button>
  </div>

  <canvas id="gameCanvas" width="375" height="667"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const foxImg = new Image();
    foxImg.src = "https://i.ibb.co/ZpTgFfVf/Adorable-Chibi-Fox-Illustration.png";

    let fox = { x: 150, y: 600, width: 40, height: 40, vy: 0, gravity: 0.12, jumpStrength: -5.4 };
    let platforms = [], hazards = [], keys = {}, tilt = 0;
    let score = 0, highestScore = 0, lives = 3, scrollOffset = 0;
    let visitedPlatforms = new Set();
    let gameEnded = false;
    let rewardFetched = false;

    const maxScore = 100;

    if (window.DeviceOrientationEvent) {
      window.addEventListener("deviceorientation", function (event) {
        tilt = event.gamma || 0;
      });
    }

    function createPlatforms() {
      platforms = [];
      hazards = [];
      visitedPlatforms.clear();
      scrollOffset = 0;
      let lastY = 650;
      for (let i = 0; i < 100; i++) {
        let y = lastY - 100;
        let x = Math.random() * (canvas.width - 60);
        platforms.push({ x, y, width: 60 });
        if (i > 20 && Math.random() < 0.3) {
          hazards.push({ x: x + 20, y: y - 20 });
        }
        lastY = y;
      }
      fox.x = platforms[0].x + 20;
      fox.y = platforms[0].y - fox.height;
      fox.vy = 0;
    }

    function drawFox() {
      ctx.drawImage(foxImg, fox.x, fox.y, fox.width, fox.height);
    }

    function drawPlatforms() {
      ctx.fillStyle = "#0077FF";
      platforms.forEach(p => ctx.fillRect(p.x, p.y + scrollOffset, p.width, 10));
    }

    function drawHazards() {
      ctx.font = "22px sans-serif";
      hazards.forEach(h => {
        ctx.fillText("‚ò†Ô∏è", h.x, h.y + scrollOffset);
      });
    }

    function drawUI() {
      ctx.font = "20px sans-serif";
      for (let i = 0; i < lives; i++) ctx.fillText("‚ù§Ô∏è", 12 + i * 22, 26);
      ctx.fillStyle = "#000";
      ctx.fillText("Po√§ng: " + score, 10, 70);
    }

    function update() {
      if (gameEnded) return;

      fox.vy += fox.gravity;
      fox.y += fox.vy;

      if (keys["ArrowLeft"]) fox.x -= 2;
      if (keys["ArrowRight"]) fox.x += 2;
      if (Math.abs(tilt) > 2) fox.x += tilt * 0.15;

      fox.x = Math.max(0, Math.min(canvas.width - fox.width, fox.x));

      platforms.forEach((p, i) => {
        const pY = p.y + scrollOffset;
        if (
          fox.vy > 0 &&
          fox.x + fox.width > p.x &&
          fox.x < p.x + p.width &&
          fox.y + fox.height >= pY &&
          fox.y + fox.height <= pY + 10
        ) {
          fox.vy = fox.jumpStrength;
          if (!visitedPlatforms.has(i)) {
            score++;
            highestScore = Math.max(highestScore, score);
            visitedPlatforms.add(i);
            if (highestScore >= 50 && !gameEnded) {
              endGame();
              return;
            }
          }
        }
      });

      hazards.forEach((h) => {
        let hY = h.y + scrollOffset;
        if (
          fox.x + fox.width > h.x + 5 &&
          fox.x < h.x + 15 &&
          fox.y + fox.height > hY + 5 &&
          fox.y < hY + 15
        ) {
          lives--;
          if (lives > 0) {
            createPlatforms();
            score = 0;
          } else {
            endGame();
          }
        }
      });

      if (fox.y < canvas.height / 2) {
        let delta = canvas.height / 2 - fox.y;
        scrollOffset += delta;
        fox.y = canvas.height / 2;
        platforms.forEach(p => p.y += delta);
        hazards.forEach(h => h.y += delta);
      }

      if (fox.y > canvas.height) {
        lives--;
        if (lives > 0) {
          createPlatforms();
          score = 0;
        } else {
          endGame();
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawPlatforms();
      drawHazards();
      drawFox();
      drawUI();
    }

    function gameLoop() {
      if (!gameEnded) {
        update();
        draw();
        requestAnimationFrame(gameLoop);
      }
    }

    function endGame() {
      if (rewardFetched) return;
      rewardFetched = true;
      gameEnded = true;

      document.getElementById("finalScore").textContent = highestScore;
      const popup = document.getElementById("gameOverPopup");
      const rewardSection = document.getElementById("rewardSection");
      const noRewardSection = document.getElementById("noRewardSection");

      if (highestScore >= 25) {
        const category = highestScore >= 50 ? 2 : 1;
        fetch("https://script.google.com/macros/s/AKfycbwMo8LRdofYLb9ne7OpJbHLJjM6GT-csazPhyoYnBs833cHtJQPHPFrXZTN4Epi-KTV/exec?category=" + category)
          .then(res => res.json())
          .then(data => {
            document.getElementById("rewardCode").textContent = data.code || "Inga koder kvar";
            rewardSection.style.display = "block";
            noRewardSection.style.display = "none";
            popup.style.display = "block";
          })
          .catch(() => {
            document.getElementById("rewardCode").textContent = "Fel vid h√§mtning av kod";
            rewardSection.style.display = "block";
            noRewardSection.style.display = "none";
            popup.style.display = "block";
          });
      } else {
        rewardSection.style.display = "none";
        noRewardSection.style.display = "block";
        popup.style.display = "block";
      }
    }

    function goBack() {
      window.location.href = "leccyapp://home";
    }

    document.getElementById("startBtn").addEventListener("click", () => {
      document.getElementById("introPopup").style.display = "none";
      createPlatforms();
      gameLoop();
    });

    document.addEventListener("keydown", e => keys[e.key] = true);
    document.addEventListener("keyup", e => keys[e.key] = false);
  </script>
</body>
</html>
